const ANNOUNCEMENT_DATA = {
    // โหลดข้อมูล JSON จากไฟล์ ประกาศเซิร์ฟ.json ที่ผู้ใช้ส่งมา
    "version": 7,
    "backups": [
        {
            "name": "restartserverswitch",
            "messages": [{"data": {"content": "<@&1386691682623291422>", "embeds": [{"description": "#    ‎‎‎‎   ‎‎‎‎‎ ‎‎‎‎‎‎<a:1_close:1408780690035703970>‎‎‎‎‎‎   ‎‎‎ RESTART SERVER     <a:1_close:1408780690035703970>", "color": 14696512}, {"description": "##  <:emoji_106:1411320430907887646> กำลังรีสตาร์ทเซิร์ฟเวอร์ <:emoji_106:1411320430907887646>\n\nหมดเวลาสนุกแล้วสิ งดเข้าก่อนประกาศเปิดน้า เตรียมตัวรอความสนุกอีกครั้งได้เลย!\n▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂", "color": 14696512, "image": {"url": "https://img2.pic.in.th/pic/RESTART.png"}}], "attachments": []}, "reference": ""}],
            "targets": [{"url": "https://discordapp.com/api/webhooks/1411755878809600071/2zZboZ1NNt3iuhMV1ltWBJNlS1duNyBx7bkxEF1Gxt_pNiLejeRxucGBbYEv0QY2sA5t"}, {"url": "https://discordapp.com/api/webhooks/1411756165314121778/7-fTOjZzeAm5y0qKXY8TKsxH4sTnqPF-e33tfMDWnQsfyZeMkYExS1qe8jwHaQP7OoFt"}]
        },
        {
            "name": "Openserversw lucky",
            "messages": [{"data": {"content": "<@&1386691682623291422>", "embeds": [{"description": "#    ‎‎‎‎   ‎‎‎‎‎ ‎‎‎‎‎‎ ‎‎‎‎‎‎ <a:1_open:1408780789511884931>‎‎‎‎  SERVER ONLINE     ‎‎‎‎‎‎‎‎ ‎‎‎‎‎‎  ‎‎‎‎‎‎‎‎‎‎‎<a:1_open:1408780789511884931>‎‎‎‎‎‎ ‎‎‎‎‎‎ ‎‎‎‎‎‎ ‎‎‎", "color": 65331}, {"description": "## <:emoji_105:1411319891939692545> เซิร์ฟเวอร์เปิดให้บริการแล้ว <:emoji_105:1411319891939692545> \nเข้าสู่ Switch CIty กันได้แล้ว\n▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂\n\n###  IP SERVER  :   \n ``` connect 89.38.101.86:30120                  ``` ‎‎‎‎‎‎ ‎‎‎‎‎‎ ‎‎‎‎‎‎ ‎‎‎‎\n###  เวลารีประเทศ :    \n ```12:00  |  18:00  |  00:00                   ``` ‎‎‎‎‎‎ ‎‎‎‎‎‎ ‎‎‎‎", "color": 65331, "image": {"url": "https://img2.pic.in.th/pic/OPENSERVER9d818cd7f42df167.png"}}, {"title": "*Lucky ID  :", "description": "``` 1 | 11 | 22 | 33 | 44 | 55 | 66 | 77 | 88 | 99  ```", "color": 65331}], "attachments": []}, "reference": ""}],
            "targets": [{"url": "https://discordapp.com/api/webhooks/1411755878809600071/2zZboZ1NNt3iuhMV1ltWBJNlS1duNyBx7bkxEF1Gxt_pNiLejeRxucGBbYEv0QY2sA5t"}, {"url": "https://discordapp.com/api/webhooks/1411756165314121778/7-fTOjZzeAm5y0qKXY8TKsxH4sTnqPF-e33tfMDWnQsfyZeMkYExS1qe8jwHaQP7OoFt"}]
        },
        {
            "name": "MAINTAINANCE",
            "messages": [{"data": {"content": "<@&1386691682623291422>", "embeds": [{"description": "#    ‎‎‎‎   ‎‎‎‎‎ ‎‎‎‎‎‎<a:Z53:1411781165458788442>  ‎‎‎ MAINTAINANCE SERVER     <a:Z53:1411781165458788442>", "color": 16737865}, {"description": "##  <a:VL80:1411784569170034748> กำลังแก้ไข อัพเดท เซิร์ฟเวอร์ <a:VL80:1411784569170034748>\n\nกรุณารอประกาศก่อนเข้าเซิร์ฟเวอร์ \n▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂", "color": 16737865, "image": {"url": "https://img2.pic.in.th/pic/MAINTAINANCE.png"}}], "attachments": []}, "reference": ""}],
            "targets": [{"url": "https://ptb.discord.com/api/webhooks/1411756320578600962/CdX-IOt_lWpyNid7lypJiZJTTNmo2yxzg5ZmtVUoVPVeTJhWnqYbk0DPl2ar-GpABjfg"}]
        },
        {
            "name": "𝗙𝗔𝗥𝗠 𝗣𝗔𝗖𝗞𝗔𝗚𝗘",
            "messages": [{"data": {"content": "<@&1386691682623291422>", "embeds": [{"description": "#    ‎‎‎‎   ‎‎‎‎‎ ‎‎‎‎‎‎<a:10_:1413166817941258364>  ‎‎‎𝗙𝗔𝗥𝗠 𝗣𝗔𝗖𝗞𝗔𝗚𝗘   <a:10_:1413166817941258364>\n<:01:1413166080599396576>DUPSTA 500 KG. \n<:01:1413166080599396576>REPAIR BOX \n<:01:13166080599396576>BOT FARM X2 \n<:01:1413166080599396576>BEER \n<:01:1413166080599396576>STEAK \nสามารถเลือกซื้อสินค้าและโดเนทได้ที่เว็ปไซต์ \n▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂", "color": 4844031, "image": {"url": "https://img5.pic.in.th/file/secure-sv1/SW-FARMPACK.png"}}], "attachments": []}, "reference": ""}],
            "targets": [{"url": "https://discordapp.com/api/webhooks/1411755878809600071/2zZboZ1NNt3iuhMV1ltWBJNlS1duNyBx7bkxEF1Gxt_pNiLejeRxucGBbYEv0QY2sA5t"}, {"url": "https://discordapp.com/api/webhooks/1411756165314121778/7-fTOjZzeAm5y0qKXY8TKsxH4sTnqPF-e33tfMDWnQsfyZeMkYExS1qe8jwHaQP7OoFt"}]
        },
        {
            "name": "vip",
            "messages": [{"data": {"content": "<@&1386691682623291422>", "embeds": [{"description": "#    ‎‎‎‎   ‎‎‎‎‎ ‎‎‎‎‎‎<:B11:1413161860911464611>  𝗩𝗜𝗣 𝗣𝗔𝗖𝗞𝗔𝗚𝗘   <:B11:1413161860911464611>", "color": 16765209}, {"description": "##   <a:Z53:1413169638006587535> คุณสมบัติของ vip  <a:Z53:1413169638006587535>\n<a:VL55:1413162003966460176>ลดเวลา PROCESS \n<a:VL55:1413162003966460176>ลดเวลานอนเตียง \n<a:VL55:1413162003966460176>ฟาร์มเร็วขึ้น 1 วิ \n<a:VL55:1413162003966460176>เปิดหลังรถได้จากวงฟาร์ม\n<a:VL55:1413162003966460176>เบิกรถได้จากวงฟาร์ม\nสามารถเลือกซื้อสินค้าและโดเนทได้ที่เว็ปไซต์ \n▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂▂", "color": 16765209, "image": {"url": "https://img2.pic.in.th/pic/SW-VIP.png"}}], "attachments": []}, "reference": ""}],
            "targets": [{"url": "https://discordapp.com/api/webhooks/1411755878809600071/2zZboZ1NNt3iuhMV1ltWBJNlS1duNyBx7bkxEF1Gxt_pNiLejeRxucGBbYEv0QY2sA5t"}, {"url": "https://discordapp.com/api/webhooks/1411756165314121778/7-fTOjZzeAm5y0qKXY8TKsxH4sTnqPF-e33tfMDWnQsfyZeMkYExS1qe8jwHaQP7OoFt"}]
        },
        {
            "name": "ค่าปรับ",
            "messages": [{"data": {"content": "<@&1386691682623291422>", "embeds": [{"description": "ชื่อ :[name]\nDiscord : <@[discord_id]>\nDiscord ID : [discord_id]\nSteam Hex : [steam_hex]\n\nโทษความผิด : [offense]\n\nค่าปรับ : [fine_amount]\n\nกำหนดจ่ายค่าปรับวันที่ : [due_date]  เวลา : [due_time] น.\n\nหากไม่ชำระภายในวันและเวลาที่กำหนด ปรับโทษเป็น ใบแดง ทันที\n\nติดต่อสอบถามและชำระค่าปรับได้ที่ https://discord.com/channels/1222655074787004489/1226336316556578826\n\nTAG : <@&1386691682623291422>", "color": 16711680, "author": {"name": "ประกาศโทษปรับจาก ADMIN", "icon_url": "https://img2.pic.in.th/pic/SWITCH_CITY_01-016f567f4fdd9b512b.png"}, "image": {"url": "https://img5.pic.in.th/file/secure-sv1/PUNISHMENT.png"}, "thumbnail": {"url": "https://img2.pic.in.th/pic/SWITCH_CITY_01-016f567f4fdd9b512b.png"}}], "attachments": []}, "reference": ""}],
            "targets": [{"url": "https://canary.discord.com/api/webhooks/1413471036963422319/rNaO6NTgl4Kx68HKl9gMvvzVKEaNgRqLBAXQqSDA3571R9gTIrVZL77FhX7onH5JTqnr"}]
        },
        {
            "name": "โทษใบเหลือง - แดง",
            "messages": [{"data": {"content": "<@&1386691682623291422>", "embeds": [{"description": "ชื่อ :[name]\nDiscord : <@[discord_id]>\nDiscord ID : [discord_id]\nSteam Hex : [steam_hex]\n\nโทษความผิด : [offense]\n\nโทษใบ : [card_type]\n\nติดต่อสอบถามรายละเอียดได้ที่ https://discord.com/channels/1222655074787004489/1226336316556578826\n\nTAG : <@&1386691682623291422>", "color": 16711680, "author": {"name": "ประกาศโทษใบเหลือง - แดง", "icon_url": "https://img2.pic.in.th/pic/SWITCH_CITY_01-016f567f4fdd9b512b.png"}, "image": {"url": "https://img5.pic.in.th/file/secure-sv1/PUNISHMENT.png"}, "thumbnail": {"url": "https://img2.pic.in.th/pic/SWITCH_CITY_01-016f567f4fdd9b512b.png"}}], "attachments": []}, "reference": ""}],
            "targets": [{"url": "https://canary.discord.com/api/webhooks/1413471186754469978/qgPjUuA634ycGEiCssPpXDxq00ri89k9DpqL9I_mkm_OrFgttx5lAU9ozOOPZ_XQlidg"}]
        },
        {
            "name": "โทษใบแดงไม่รีใบ",
            "messages": [{"data": {"content": "<@&1386691682623291422>", "embeds": [{"description": "ชื่อ :[name]\nDiscord : <@[discord_id]>\nDiscord ID : [discord_id]\nSteam Hex : [steam_hex]\n\nโทษความผิด : [offense]\n\nโทษใบแดง : ไม่รีใบทุกกรณี \n\nTAG : <@&1386691682623291422>", "color": 16711680, "author": {"name": "ประกาศโทษใบแดง - ไม่รีใบ", "icon_url": "https://img2.pic.in.th/pic/SWITCH_CITY_01-016f567f4fdd9b512b.png"}, "image": {"url": "https://img5.pic.in.th/file/secure-sv1/PUNISHMENT.png"}, "thumbnail": {"url": "https://img2.pic.in.th/pic/SWITCH_CITY_01-016f567f4fdd9b512b.png"}}], "attachments": []}, "reference": ""}],
            "targets": [{"url": "https://canary.discord.com/api/webhooks/1413471284871954503/wsPO6pH2RvUKBBIpX6eJNHWK_-OhJAvZsB0plZvM74oag31Oa84Tye1yDWmXqZ2E0D_M"}]
        }
    ]
};

let currentTemplateName = null;

// Utility function to convert Decimal Color (from JSON) to Hex Color (for CSS)
function decToHex(dec) {
    if (dec === undefined) return '#ffffff'; // Default to white if no color specified
    const hex = dec.toString(16);
    return '#' + ('000000' + hex).slice(-6);
}

// 1. Initial Load: Create Category Tabs and Forms
document.addEventListener('DOMContentLoaded', () => {
    const navPillsContainer = document.getElementById('pills-tab');
    const tabContentContainer = document.getElementById('pills-tabContent');

    ANNOUNCEMENT_DATA.backups.forEach((item, index) => {
        const id = 'tab-' + index;
        const name = item.name;
        const isActive = index === 0;

        // Create Tab Button
        const tabButton = `
            <li class="nav-item" role="presentation">
                <button class="nav-link ${isActive ? 'active' : ''}" id="${id}-tab" data-bs-toggle="pill" 
                        data-bs-target="#${id}" type="button" role="tab" aria-controls="${id}" 
                        aria-selected="${isActive}" onclick="setActiveTemplate('${name}')">${name}</button>
            </li>
        `;
        navPillsContainer.innerHTML += tabButton;

        // Create Tab Content (Form Structure)
        const formHtml = createFormHtml(name);
        const tabContent = `
            <div class="tab-pane fade ${isActive ? 'show active' : ''}" id="${id}" role="tabpanel" aria-labelledby="${id}-tab">
                <form id="form-${name}" class="announcement-form" data-template-name="${name}">
                    ${formHtml}
                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-lg btn-send"><i class="fas fa-paper-plane"></i> ส่งประกาศไปยัง Discord</button>
                    </div>
                </form>
            </div>
        `;
        tabContentContainer.innerHTML += tabContent;
    });

    // Add event listeners to all forms
    document.querySelectorAll('.announcement-form').forEach(form => {
        form.addEventListener('submit', handleFormSubmission);
        form.addEventListener('input', updatePreview);
    });

    // Set initial template and update preview for the first tab
    if (ANNOUNCEMENT_DATA.backups.length > 0) {
        setActiveTemplate(ANNOUNCEMENT_DATA.backups[0].name);
    }
});

// 2. Form HTML Generation (Handles required fields for punishment templates)
function createFormHtml(templateName) {
    let formFields = '';
    let formTitle = templateName;

    // Define specific fields for templates that require user input
    const requiredFields = {
        'ค่าปรับ': [
            { id: 'name', label: 'ชื่อผู้ถูกลงโทษ', type: 'text', placeholder: 'กรอกชื่อตัวละคร' },
            { id: 'discord_id', label: 'Discord ID (สำหรับ Tag)', type: 'text', placeholder: 'ID ผู้ใช้ Discord (เช่น 123456789012345678)', help: 'ใช้สำหรับ @Mention ใน Discord' },
            { id: 'steam_hex', label: 'Steam Hex ID', type: 'text', placeholder: 'Steam Hex ID' },
            { id: 'offense', label: 'รายละเอียดความผิด', type: 'textarea', placeholder: 'ระบุความผิดที่ชัดเจน' },
            { id: 'fine_amount', label: 'ค่าปรับ (จำนวนเงิน)', type: 'number', placeholder: 'เช่น 50000' },
            { id: 'due_date', label: 'กำหนดจ่าย (วันที่)', type: 'date' },
            { id: 'due_time', label: 'กำหนดจ่าย (เวลา)', type: 'time' }
        ],
        'โทษใบเหลือง - แดง': [
            { id: 'name', label: 'ชื่อผู้ถูกลงโทษ', type: 'text', placeholder: 'กรอกชื่อตัวละคร' },
            { id: 'discord_id', label: 'Discord ID (สำหรับ Tag)', type: 'text', placeholder: 'ID ผู้ใช้ Discord (เช่น 123456789012345678)' },
            { id: 'steam_hex', label: 'Steam Hex ID', type: 'text', placeholder: 'Steam Hex ID' },
            { id: 'offense', label: 'รายละเอียดความผิด', type: 'textarea', placeholder: 'ระบุความผิดที่ชัดเจน' },
            { id: 'card_type', label: 'ประเภทโทษ', type: 'select', options: ['ใบเหลืองที่ 1', 'ใบเหลืองที่ 2', 'ใบแดง'] }
        ],
        'โทษใบแดงไม่รีใบ': [
            { id: 'name', label: 'ชื่อผู้ถูกลงโทษ', type: 'text', placeholder: 'กรอกชื่อตัวละคร' },
            { id: 'discord_id', label: 'Discord ID (สำหรับ Tag)', type: 'text', placeholder: 'ID ผู้ใช้ Discord (เช่น 123456789012345678)' },
            { id: 'steam_hex', label: 'Steam Hex ID', type: 'text', placeholder: 'Steam Hex ID' },
            { id: 'offense', label: 'รายละเอียดความผิด', type: 'textarea', placeholder: 'ระบุความผิดที่ชัดเจน' }
        ]
    };

    const fields = requiredFields[templateName];

    if (fields) {
        fields.forEach(field => {
            let inputHtml = '';
            // Determine if the field is required based on its existence in the dynamic list
            const requiredAttr = 'required'; 

            if (field.type === 'select') {
                const optionsHtml = field.options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
                inputHtml = `<select class="form-select" id="${templateName}-${field.id}" name="${field.id}" ${requiredAttr}>${optionsHtml}</select>`;
            } else if (field.type === 'textarea') {
                inputHtml = `<textarea class="form-control" id="${templateName}-${field.id}" name="${field.id}" placeholder="${field.placeholder}" rows="3" ${requiredAttr}></textarea>`;
            } else {
                inputHtml = `<input type="${field.type}" class="form-control" id="${templateName}-${field.id}" name="${field.id}" placeholder="${field.placeholder || ''}" ${requiredAttr}>`;
            }

            formFields += `
                <div class="mb-3">
                    <label for="${templateName}-${field.id}" class="form-label fw-bold"><i class="fas fa-dot-circle text-primary me-1"></i> ${field.label}:</label>
                    ${inputHtml}
                    ${field.help ? `<div class="form-text">${field.help}</div>` : ''}
                </div>
            `;
        });
    } else {
        // Static announcements have no custom fields
        formFields = `
            <div class="alert alert-success text-center border-2 border-success">
                <i class="fas fa-check-circle"></i> ประกาศนี้เป็นแบบสำเร็จรูป **ไม่จำเป็นต้องกรอกข้อมูลเพิ่มเติม**
            </div>
        `;
        formTitle = `${templateName} (สำเร็จรูป)`;
    }
    
    document.getElementById('current-form-title').textContent = formTitle;
    return formFields;
}

// 3. Set Active Template (used when clicking tabs)
function setActiveTemplate(templateName) {
    currentTemplateName = templateName;
    document.getElementById('form-placeholder').style.display = 'none'; // Hide placeholder
    updatePreview();
}

// 4. Update Live Preview
function updatePreview() {
    if (!currentTemplateName) return;

    const templateData = ANNOUNCEMENT_DATA.backups.find(t => t.name === currentTemplateName);
    if (!templateData) return;

    const form = document.getElementById(`form-${currentTemplateName}`);
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    // Get the final payload (with replacements)
    const payload = generatePayload(templateData, data);
    
    const previewContainer = document.getElementById('discord-preview-container');
    previewContainer.innerHTML = '';

    if (payload.embeds && payload.embeds.length > 0) {
        payload.embeds.forEach(embed => {
            // Function to strip Discord Custom Emoji/Formatting for clean HTML display
            const cleanText = (text) => {
                if (!text) return '';
                let cleaned = text;
                // Remove custom emojis (<:name:id>, <a:name:id>) and zero-width spaces (‎)
                cleaned = cleaned.replace(/<a?:\w+:\d+>|‎/g, ''); 
                // Convert simple Discord markdown to HTML
                cleaned = cleaned.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
                cleaned = cleaned.replace(/#+ (.*)/g, '<h4>$1</h4>'); // Headings
                cleaned = cleaned.replace(/```(.*?)```/gs, '<pre style="background:#2f3136; padding:5px; border-radius:3px; color:#b9bbbe; overflow-x:auto;">$1</pre>'); // Code blocks
                cleaned = cleaned.replace(/@\d+/g, '@User'); // Simple mention cleanup
                return cleaned;
            };

            const embedHtml = `
                <div class="discord-embed" style="border-left-color: ${decToHex(embed.color || 0)};">
                    ${embed.thumbnail && embed.thumbnail.url ? `<img src="${embed.thumbnail.url}" class="embed-thumbnail" alt="Thumbnail">` : ''}
                    ${embed.author && embed.author.name ? `<div class="embed-author"><img src="${embed.author.icon_url || 'https://i.imgur.com/7T2Hw3M.png'}" alt="Author Icon">${cleanText(embed.author.name)}</div>` : ''}
                    ${embed.title ? `<div class="embed-title">${cleanText(embed.title)}</div>` : ''}
                    ${embed.description ? `<div class="embed-description">${cleanText(embed.description).replace(/\n/g, '<br>')}</div>` : ''}
                    ${embed.image && embed.image.url ? `<img src="${embed.image.url}" class="embed-image" alt="Image">` : ''}
                </div>
            `;
            previewContainer.innerHTML += embedHtml;
        });
        
        // Add content separately (above embeds)
        if(payload.content) {
            // Attempt to resolve the role mention for display
            const roleMention = payload.content.replace(/<@&(\d+)>|‎/g, '@Role-Mention');
            const contentDiv = `<div class="text-white mb-2" style="font-size: 0.9em; font-weight: 500;">${roleMention}</div>`;
            previewContainer.innerHTML = contentDiv + previewContainer.innerHTML;
        }

    } else {
        previewContainer.innerHTML = '<p class="text-white-50 text-center">ตัวอย่างข้อความจะแสดงที่นี่</p>';
    }
}

// 5. Generate Final Webhook Payload (The payload sent to Discord)
function generatePayload(templateData, formData) {
    // Deep clone the original message data
    let payload = JSON.parse(JSON.stringify(templateData.messages[0].data));

    // Handle string replacements for punishment templates
    const replacements = {
        '[name]': formData.name || 'ชื่อผู้ถูกลงโทษ',
        '[discord_id]': formData.discord_id || '000000000000000000',
        '[steam_hex]': formData.steam_hex || 'STEAM_HEX',
        '[offense]': formData.offense || 'ระบุความผิด',
        '[fine_amount]': formData.fine_amount ? parseInt(formData.fine_amount).toLocaleString('th-TH') + ' บาท' : '0 บาท',
        '[due_date]': formData.due_date || '00/00/0000',
        '[due_time]': formData.due_time || '00.00',
        '[card_type]': formData.card_type || 'ประเภทโทษ'
    };

    if (payload.embeds) {
        payload.embeds.forEach(embed => {
            if (embed.description) {
                let newDescription = embed.description;
                
                // Date and Time formatting
                const formattedDate = formData.due_date ? formData.due_date.split('-').reverse().join('/') : '00/00/0000';
                const formattedTime = formData.due_time || '00.00';

                // Perform replacements in description
                newDescription = newDescription.replace(new RegExp('\\[name\\]', 'g'), replacements['[name]']);
                newDescription = newDescription.replace(new RegExp('\\[discord_id\\]', 'g'), replacements['[discord_id]']);
                newDescription = newDescription.replace(new RegExp('\\[steam_hex\\]', 'g'), replacements['[steam_hex]']);
                newDescription = newDescription.replace(new RegExp('\\[offense\\]', 'g'), replacements['[offense]']);
                newDescription = newDescription.replace(new RegExp('\\[fine_amount\\]', 'g'), replacements['[fine_amount]']);
                newDescription = newDescription.replace(new RegExp('\\[card_type\\]', 'g'), replacements['[card_type]']);
                
                // Specific replacements for the date/time fields that have default values in the JSON
                if (templateData.name === 'ค่าปรับ') {
                    newDescription = newDescription.replace('กำหนดจ่ายค่าปรับวันที่ : 00/00/0000', `กำหนดจ่ายค่าปรับวันที่ : ${formattedDate}`);
                    newDescription = newDescription.replace('เวลา : 00.00 น.', `เวลา : ${formattedTime} น.`);
                    
                    // The Discord tag replacement is special: it needs to use the <@ID> format for the actual webhook
                    newDescription = newDescription.replace('Discord : <@[discord_id]>', `Discord : <@${formData.discord_id || '000000000000000000'}>`);
                }

                // Apply the final modified description
                embed.description = newDescription;
            }
        });
    }

    return payload;
}


// 6. Handle Form Submission (Send Webhook)
async function handleFormSubmission(event) {
    event.preventDefault();

    const templateName = event.target.getAttribute('data-template-name');
    const templateData = ANNOUNCEMENT_DATA.backups.find(t => t.name === templateName);
    
    if (!templateData) {
        alert('เกิดข้อผิดพลาด: ไม่พบ Template ประกาศ');
        return;
    }

    const formData = new FormData(event.target);
    const data = Object.fromEntries(formData.entries());

    // 1. Get final payload
    const payload = generatePayload(templateData, data);
    
    // 2. Get webhook URLs
    const webhookUrls = templateData.targets.map(t => t.url);
    if (webhookUrls.length === 0) {
        alert('เกิดข้อผิดพลาด: ไม่พบ Webhook URL ใน Template นี้');
        return;
    }

    const sendButton = event.target.querySelector('button[type="submit"]');
    sendButton.disabled = true;
    sendButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> กำลังส่ง...';
    
    let successCount = 0;
    let failCount = 0;

    for (const url of webhookUrls) {
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                successCount++;
            } else {
                failCount++;
                console.error(`Error sending to ${url}:`, response.status, await response.text());
            }
        } catch (error) {
            failCount++;
            console.error(`Fetch error to ${url}:`, error);
        }
    }
    
    sendButton.disabled = false;
    sendButton.innerHTML = '<i class="fas fa-paper-plane"></i> ส่งประกาศไปยัง Discord';

    if (successCount > 0 && failCount === 0) {
        alert(`✅ ส่งประกาศสำเร็จ! จำนวน ${successCount} Webhook`);
        // event.target.reset(); // Optional: Clear form after successful submission
    } else if (successCount > 0 && failCount > 0) {
        alert(`⚠️ ส่งประกาศสำเร็จ ${successCount} Webhook แต่มีข้อผิดพลาด ${failCount} Webhook`);
    } else {
        alert('❌ ส่งประกาศล้มเหลวทั้งหมด! กรุณาตรวจสอบ Webhook URL และ Payload ใน Console');
    }
}